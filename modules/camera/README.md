# Camera 模块

## 概述
Camera模块负责TOF（Time-of-Flight）相机的管理和图像处理。该模块提供了与TOF相机硬件交互的接口，处理RGB和深度图像数据，并进行坐标转换和相机内参管理。

## 核心组件

### 1. TOFCameraManager (`tof_manager.py`)
**功能**：TOF相机资源管理器，负责相机的初始化、数据采集和资源清理。

**主要特性**：
- 自动检测和连接TOF相机设备
- 支持以太网和USB接口的TOF相机
- 图像对齐功能（深度图对齐到RGB坐标系）
- RGBD输出模式支持
- 优雅的错误处理和降级机制

**关键方法**：
- `initialize()`: 初始化相机连接和配置
- `fetch_frame(timeout)`: 获取一帧RGBD数据
- `cleanup()`: 清理相机资源
- 支持上下文管理器协议（`with`语句）

**使用示例**：
```python
with TOFCameraManager() as camera:
    frame_data = camera.fetch_frame(timeout=5000)
    if frame_data:
        # 处理帧数据
        pass
```

### 2. CameraIntrinsicsManager (`intrinsics.py`)
**功能**：相机内参管理器，从相机SDK获取并管理相机的内部参数。

**主要特性**：
- 自动从SDK获取RGB和深度相机内参
- 提供焦距(fx, fy)和主点(cx, cy)参数
- 支持内参的字典格式输出
- 验证内参的有效性

**内参参数说明**：
- `fx`, `fy`: 焦距（以像素为单位）
- `cx`, `cy`: 主点坐标（图像中心）
- 用于3D重建和深度计算

### 3. CoordinateConverter (`coordinate_converter.py`)
**功能**：坐标转换器，实现2D图像坐标与3D世界坐标之间的转换。

**主要功能**：
- 像素坐标到3D点的转换
- 深度值到世界坐标的映射
- 支持畸变校正
- 提供逆投影计算

**关键方法**：
- `pixel_to_3d(x, y, depth)`: 将像素坐标转换为3D点
- `project_3d_to_2d(point_3d)`: 将3D点投影到2D图像平面

### 4. ImageDataProcessor (`image_processor.py`)
**功能**：图像数据处理器，处理RGB和深度图像数据。

**主要功能**：
- RGB图像格式转换（YUV422到RGB）
- 深度图像处理和滤波
- 图像对齐和配准
- 深度值单位转换（毫米）
- 深度图可视化（伪彩色）

**数据处理流程**：
1. 接收原始相机数据
2. 格式转换和解码
3. 深度图滤波去噪
4. 坐标系对齐
5. 输出处理后的图像

### 5. 配置管理 (`config.py`)
**功能**：相机模块的配置参数管理。

**配置项**：
- 相机连接参数
- 图像分辨率设置
- 深度范围限制
- 滤波器参数
- 性能优化选项

## 技术特点

### 深度测量原理
- 使用TOF技术测量深度
- 通过测量光飞行时间计算距离
- 支持毫米级精度
- 有效范围：200mm - 1500mm

### 图像对齐
- RGB和深度图像自动对齐
- 消除视差造成的偏移
- 保证深度值与RGB像素一一对应

### 错误处理
- 相机断连自动重连
- API不可用时的优雅降级
- 详细的错误日志记录

## 依赖关系
- **外部SDK**：Mv3dRgbdApi（TOF相机SDK）
- **Python库**：
  - numpy: 数组处理
  - opencv-python: 图像处理
  - ctypes: SDK接口调用

## 性能优化
- 使用缓冲区减少内存分配
- 支持GPU加速（如果可用）
- 异步数据获取
- 智能帧率控制

## 常见问题

### Q: 相机无法连接怎么办？
A: 检查以下项目：
1. 相机驱动是否安装
2. USB/网络连接是否正常
3. SDK DLL文件是否在正确路径
4. 查看日志中的具体错误信息

### Q: 深度数据不准确？
A: 可能的原因：
1. 相机未预热（建议预热30秒）
2. 环境光线干扰
3. 目标表面反射率过低
4. 超出有效测量范围

### Q: 如何提高帧率？
A: 优化建议：
1. 降低图像分辨率
2. 减少深度滤波迭代
3. 使用GPU加速
4. 优化后续处理算法

## 扩展性
该模块设计为可扩展架构，支持：
- 添加新的相机型号
- 自定义图像处理滤波器
- 扩展坐标转换功能
- 集成其他深度相机SDK